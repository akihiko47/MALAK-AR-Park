<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo with Favorite Characters in Augmented Reality</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="styles.css">
    
    <style>
        /* Улучшение качества рендеринга */
        .a-canvas {
            width: 100% !important;
            height: 100% !important;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }
    </style>
</head>
<body>
    <a-scene 
        mindar-image="
            imageTargetSrc: ./targets-night.mind; 
            filterMinCF: 0.0001; 
            filterBeta: 0.001; 
            warmupTolerance: 3; 
            missTolerance: 1; 
            uiScanning: #custom-scanning-overlay; 
            resolution: 1920; 
            maxTrack: 1;
            video: {
                width: {ideal: 3840, min: 1920, max: 3840},
                height: {ideal: 2160, min: 1080, max: 2160},
                frameRate: {ideal: 60, min: 30},
                facingMode: 'environment',
                aspectRatio: {ideal: 16/9},
                resizeMode: 'crop-and-scale'
            }" 
        xr-mode-ui="enabled: false"
        renderer="
            colorManagement: true;
            precision: high;
            antialias: true;
            anisotropy: 16;
            physicallyCorrectLights: true;
            sortObjects: true;
            powerPreference: high-performance"
        stats="false"
        background="color: #000000">
        
        <script src="photo-capture.js"></script>
        <a-assets>
            <a-asset-item id="scene1" src="models/scene1/scene1.gltf"></a-asset-item>
            <a-asset-item id="scene2" src="models/scene2/scene2.gltf"></a-asset-item>
        </a-assets>
        
        <div id="custom-scanning-overlay" class="hidden">
            <div class="scanner"></div>
            <div id="custom-scanning-text">
                <div class="scanning-content">
                    <h1>Добро пожаловать!</h1>
                    <p>Наведите камеру на скульптуру, убедитесь что стоите прямо перед ней и на улице светло</p>
                </div>
            </div>
        </div>
        
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false"
            wasd-controls="enabled: false">
        </a-camera>

        <!-- Scene1 M Night -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-gltf-model 
                rotation="30 0 0" 
                position="0 -0.3 0" 
                scale="0.1 0.1 0.1" 
                src="#scene1"
                animation-mixer
                shadow="receive: true"
                render-order="1">
            </a-gltf-model>
        </a-entity>

        <!-- Scene2 M Night -->
        <a-entity mindar-image-target="targetIndex: 1">
            <a-gltf-model 
                rotation="15 0 0" 
                position="0 -0.15 0" 
                scale="0.1 0.1 0.1" 
                src="#scene2"
                animation-mixer
                shadow="receive: true"
                render-order="1">
            </a-gltf-model>
        </a-entity>
    </a-scene>

    <div id="photoModal" style="display: none;">
        <img id="capturedPhoto" src="" alt="Photo" />
        <div>
            <button id="saveBtn">Сохранить</button>
            <button id="ticketBtn">Билет</button>
            <button id="backBtn">Назад</button>
        </div>
    </div>

    <button id="photoBtn" title="Take Photo"></button>
    
    <script>
        // Дополнительная инициализация для максимального качества
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener('loaded', function() {
                console.log('A-Frame scene loaded with high quality settings');
                
                // Принудительный рендеринг в высоком качестве
                if (scene.renderer) {
                    const renderer = scene.renderer;
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    console.log('Renderer pixel ratio:', renderer.getPixelRatio());
                }
            });
        });
        
        // Автоматическое определение дня/ночи
        window.addEventListener("DOMContentLoaded", () => {
            const hour = new Date().getHours();
            const isNight = (hour >= 18 || hour < 6);
            const targetFile = isNight ? "targets-night.mind" : "targets-day.mind";

            const scene = document.querySelector('a-scene');
            
            if (scene) {  
                scene.setAttribute(
                    "mindar-image",
                    `imageTargetSrc: ./${targetFile}; 
                     filterMinCF: 0.0001; 
                     filterBeta: 0.001; 
                     warmupTolerance: 3; 
                     missTolerance: 1; 
                     uiScanning: #custom-scanning-overlay; 
                     resolution: 1920; 
                     maxTrack: 1;
                     video: {
                         width: {ideal: 3840, min: 1920, max: 3840},
                         height: {ideal: 2160, min: 1080, max: 2160},
                         frameRate: {ideal: 60, min: 30},
                         facingMode: 'environment',
                         aspectRatio: {ideal: 16/9}
                     }`
                );
                console.log("High quality mode activated with file:", targetFile);
            }
        });
    </script>
</body>
</html>
